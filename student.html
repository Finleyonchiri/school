<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal - Borabu TTC</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- For icons -->
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e0f7fa, #f8e1e1); /* Teal to soft pink gradient */
      min-height: 100vh;
      color: #2d2d2d;
    }
    .container {
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
    /* Mobile Menu */
    .top-menu {
      display: none;
      background: #00695c; /* Teal */
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .menu-toggle {
      font-size: 24px;
      color: #fff;
      background: none;
      border: none;
      cursor: pointer;
    }
    .menu-content {
      display: none;
      flex-direction: column;
      background: #00695c;
    }
    .menu-content a {
      color: #fff;
      padding: 12px;
      text-decoration: none;
      font-size: 16px;
    }
    .menu-content a:hover {
      background: #004d40;
    }
    .sidebar {
      width: 100%;
      background: linear-gradient(to bottom, #00695c, #004d40); /* Teal gradient */
      color: #fff;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      text-align: center;
      transition: transform 0.3s ease;
    }
    .sidebar .profile {
      margin-bottom: 20px;
    }
    .sidebar .profile img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 4px solid #ffd700; /* Gold border */
      margin-bottom: 10px;
      transition: transform 0.3s ease;
    }
    .sidebar .profile img:hover {
      transform: scale(1.1);
    }
    .sidebar h2 {
      font-size: 22px;
      margin-bottom: 20px;
      font-weight: 600;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    .sidebar a {
      display: block;
      color: #fff;
      padding: 14px;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.15);
      margin-bottom: 12px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .sidebar a:hover {
      background: #ffd700; /* Gold hover */
      color: #004d40;
      transform: translateX(5px);
    }
    .main-content {
      flex: 1;
      padding: 20px;
    }
    .section {
      display: none;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border-left: 5px solid #ff7043; /* Coral accent */
      animation: fadeIn 0.5s ease-in;
    }
    .section.active {
      display: block;
    }
    h1 {
      font-size: 28px;
      color: #00695c; /* Teal */
      margin-bottom: 15px;
      font-weight: 700;
      border-bottom: 2px solid #ffd700; /* Gold line */
      padding-bottom: 5px;
    }
    h2 {
      color: #ff7043; /* Coral */
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .card {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 15px;
    }
    th, td {
      border: 2px solid #b0bec5; /* Light blue-gray */
      padding: 10px;
      text-align: left;
    }
    th {
      background: #ffca28; /* Amber */
      color: #fff;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #eceff1; /* Light gray */
    }
    .fees-highlight {
      font-weight: 700;
      color: #00695c;
      background: #e0f2f1; /* Light teal */
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
    }
    .announcement {
      background: #fff3e0; /* Light orange */
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #ff7043;
      transition: transform 0.3s ease;
    }
    .announcement:hover {
      transform: translateX(10px);
    }
    .announcement.unread {
      background: #ffe0b2;
      font-weight: 500;
    }
    .announcement.read {
      background: #fff3e0;
    }
    .mark-read {
      background: #ff7043; /* Coral */
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    .mark-read:hover {
      background: #f4511e; /* Darker coral */
    }
    button {
      padding: 12px 20px;
      background: linear-gradient(to right, #00695c, #ff7043); /* Teal to coral */
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
      background: linear-gradient(to right, #ff7043, #00695c);
    }
    .error-message {
      color: #d32f2f; /* Red */
      font-size: 15px;
      margin: 10px 0;
      padding: 10px;
      background: #ffebee; /* Light red */
      border-radius: 5px;
    }
    /* Payment Section Styling */
    .payment-center {
      text-align: center;
      padding: 20px;
      background: #fffde7; /* Light yellow */
      border-radius: 12px;
      border: 2px dashed #ffca28; /* Amber */
    }
    .payment-center h1 {
      font-size: 30px;
      color: #ff7043;
      margin-bottom: 15px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
    .payment-assurance {
      list-style: none;
      padding: 0;
      margin: 15px 0;
    }
    .payment-assurance li {
      margin: 10px 0;
      font-size: 16px;
      color: #00695c;
      display: flex;
      align-items: center;
    }
    .payment-assurance li i {
      color: #4caf50; /* Green for ticks */
      margin-right: 10px;
      font-size: 18px;
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Media Queries */
    @media (max-width: 768px) {
      .top-menu { display: block; }
      .sidebar {
        position: fixed;
        top: 60px;
        left: -100%;
        height: calc(100% - 60px);
        transition: left 0.3s ease;
      }
      .sidebar.active { left: 0; }
      .container { flex-direction: column; }
      .main-content { padding: 15px; }
      .menu-toggle.active ~ .menu-content { display: flex; }
      .menu-toggle { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar {
        width: 250px;
        text-align: left;
      }
      .main-content { padding: 30px; }
      .section { padding: 30px; }
      h1 { font-size: 32px; }
      h2 { font-size: 22px; }
      .card { padding: 20px; }
      th, td { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-menu">
      <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
      <div class="menu-content">
        <a href="#" onclick="showSection('profile')">Profile</a>
        <a href="#" onclick="showSection('marks')">Marks</a>
        <a href="#" onclick="showSection('fees')">Fees</a>
        <a href="#" onclick="showSection('payFees')">Pay Fees</a>
        <a href="#" onclick="showSection('announcements')">Announcements</a>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="sidebar">
      <div class="profile">
        <img src="https://img.icons8.com/color/80/000000/student-male.png" alt="Student Icon">
        <p id="studentName"></p>
      </div>
      <h2>Student Portal</h2>
      <a href="#" onclick="showSection('profile')">Profile</a>
      <a href="#" onclick="showSection('marks')">Marks</a>
      <a href="#" onclick="showSection('fees')">Fees</a>
      <a href="#" onclick="showSection('payFees')">Pay Fees</a>
      <a href="#" onclick="showSection('announcements')">Announcements</a>
      <button onclick="logout()">Logout</button>
    </div>
    <div class="main-content">
      <div id="profile" class="section active">
        <h1>Profile</h1>
        <p><strong>Explanation:</strong> View and manage your personal details, including admission number, name, year, stream, gender, sponsor, and parent contact information.</p>
        <div class="card">
          <p>Admission Number: <strong id="regNo"></strong></p>
          <p>Name: <strong id="name">N/A</strong></p>
          <p>Year: <strong id="year">N/A</strong></p>
          <p>Stream: <strong id="stream">N/A</strong></p>
          <p>Gender: <strong id="gender">N/A</strong></p>
          <p>Sponsor: <strong id="sponsor">N/A</strong></p>
          <p>Parent Name: <strong id="parentName">N/A</strong></p>
          <p>Parent Phone: <strong id="parentPhone">N/A</strong></p>
        </div>
      </div>
      <div id="marks" class="section">
        <h1>Marks</h1>
        <p><strong>Explanation:</strong> Check your academic performance with CAT and exam scores across different terms and subjects, along with corresponding grades.</p>
        <div class="card">
          <table id="marksTable">
            <thead>
              <tr>
                <th>Term</th>
                <th>Subject</th>
                <th>CAT Score</th>
                <th>Exam Score</th>
                <th>Grade</th>
              </tr>
            </thead>
            <tbody id="marksBody"></tbody>
          </table>
        </div>
      </div>
      <div id="fees" class="section">
        <h1>Fees</h1>
        <p><strong>Explanation:</strong> Monitor your fee status, including total amount, payments made, outstanding balance, and a detailed transaction history.</p>
        <div class="card">
          <p>Total: <span class="fees-highlight" id="feesTotal">N/A</span></p>
          <p>Paid: <span class="fees-highlight" id="feesPaid">N/A</span></p>
          <p>Balance: <span class="fees-highlight" id="feesBalance">N/A</span></p>
          <p>Statement: <span id="feesStatement">N/A</span></p>
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Payer</th>
                <th>Transaction Code</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
        </div>
      </div>
      <div id="payFees" class="section">
        <h1>Pay Fees</h1>
        <p><strong>Explanation:</strong> Access a secure payment portal to settle your fees. Our team ensures accuracy and support for any issues.</p>
        <div class="payment-center">
          <h1>Welcome to Borabu TTC Fee Payment Centre</h1>
          <p>Make your payments with ease and confidence!</p>
          <ul class="payment-assurance">
            <li><i class="fas fa-check-circle"></i> Fast Processing</li>
            <li><i class="fas fa-check-circle"></i> Reliable Service</li>
            <li><i class="fas fa-check-circle"></i> Trusted Platform</li>
            <li><i class="fas fa-check-circle"></i> Secure Transactions</li>
            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
          </ul>
          <button onclick="window.open('https://payment.intasend.com/pay/b90e1c19-33da-4b7d-a654-c4fb72eb9ea7/', '_blank')">Pay Now</button>
          <p>After payment, please contact the Accounts Office to confirm receipt. For issues, visit the office for assistance.</p>
        </div>
      </div>
      <div id="announcements" class="section">
        <h1>Announcements</h1>
        <p><strong>Explanation:</strong> Stay updated with the latest news, notices, and messages from teachers or administrators.</p>
        <div class="card">
          <div id="announcementsList"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="errorMessage" class="error-message"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCi9NWfDwbWSByd_R7ueNkLcQsFlBJ5_VA",
      authDomain: "web-reg-cbf2f.firebaseapp.com",
      databaseURL: "https://web-reg-cbf2f-default-rtdb.firebaseio.com",
      projectId: "web-reg-cbf2f",
      storageBucket: "web-reg-cbf2f.firebasestorage.app",
      messagingSenderId: "431303341740",
      appId: "1:431303341740:web:542070e4c471cd7c8ad109",
      measurementId: "G-164GMVZQY3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function showSection(section) {
      document.querySelectorAll(".section").forEach(div => div.classList.remove("active"));
      document.getElementById(section).classList.add("active");
    }

    function showError(message) {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.textContent = message;
      errorDiv.style.display = "block";
      setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
    }

    function getUserNameByEmail(email, role) {
      return db.ref(`users/${role}`).once("value").then(snapshot => {
        const users = snapshot.val() || {};
        for (let key in users) {
          if (users[key].email === email || users[key].email === email + ".stacc@moke.ac") {
            return users[key].name || email;
          }
        }
        return email;
      }).catch(() => email);
    }

    function toggleMenu() {
      const sidebar = document.querySelector(".sidebar");
      const menuToggle = document.querySelector(".menu-toggle");
      sidebar.classList.toggle("active");
      menuToggle.classList.toggle("active");
    }

    window.onload = function() {
      const userType = sessionStorage.getItem("userType");
      const regNo = sessionStorage.getItem("regNo");
      const studentName = sessionStorage.getItem("studentName");
      console.log("Student.html loaded, sessionStorage:", userType, regNo, studentName);

      if (userType !== "student" || !regNo) {
        console.log("Redirecting to index.html: Invalid session");
        window.location.href = "index.html";
        return;
      }

      document.getElementById("studentName").textContent = studentName || "Student";
      document.getElementById("regNo").textContent = regNo.replace(/_/g, "/");

      const studentRef = db.ref("users/students/" + regNo.replace(/\//g, "_"));
      studentRef.once("value", (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          // Profile
          const profile = data.profile || {};
          document.getElementById("name").textContent = profile.name || data.name || "N/A";
          document.getElementById("year").textContent = profile.year || data.form?.replace("form", "Year ") || "N/A";
          document.getElementById("stream").textContent = profile.stream || data.stream || "N/A";
          document.getElementById("gender").textContent = profile.gender || data.gender || "N/A";
          document.getElementById("sponsor").textContent = profile.sponsor || data.sponsor || "N/A";
          document.getElementById("parentName").textContent = profile.parentName || data.parentName || "N/A";
          document.getElementById("parentPhone").textContent = profile.parentPhone || data.parentPhone || "N/A";

          // Marks
          const marksBody = document.getElementById("marksBody");
          marksBody.innerHTML = "";
          const terms = ["term1"];
          let hasMarks = false;
          terms.forEach(term => {
            const termData = data.marks?.[term] || data.academics?.[term];
            if (termData) {
              hasMarks = true;
              for (const [subject, catScore] of Object.entries(termData.cat || {})) {
                const examScore = termData.exam?.[subject] || (termData[subject] || "-");
                const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "-";
                marksBody.innerHTML += `<tr>
                  <td>${term.replace("term", "Term ")}</td>
                  <td>${subject}</td>
                  <td>${catScore !== undefined ? catScore : "-"}</td>
                  <td>${examScore !== undefined ? examScore : "-"}</td>
                  <td>${grade}</td>
                </tr>`;
              }
            }
          });
          if (!hasMarks) {
            marksBody.innerHTML = "<tr><td colspan='5'>No marks available</td></tr>";
          }

          // Fees
          const feesData = data.fees || {};
          const total = feesData.total || feesData.totalExpected || 0;
          const paidFromDb = feesData.paid || 0;
          const transactions = feesData.transactions || [];
          let totalPaid = paidFromDb;
          if (Array.isArray(transactions)) {
            totalPaid += transactions.reduce((sum, tx) => sum + (tx.amount || 0), 0);
          } else if (typeof transactions === "object") {
            totalPaid += Object.values(transactions).reduce((sum, tx) => sum + (tx.amount || 0), 0);
          }
          const balanceFromDb = feesData.balance !== undefined ? feesData.balance : null;
          const calculatedBalance = Math.max(0, total - totalPaid);
          const balance = balanceFromDb !== null ? balanceFromDb : calculatedBalance;
          const statement = feesData.statement || "N/A";
          console.log(`Fees - Total: ${total}, Paid (DB: ${paidFromDb}, Total: ${totalPaid}), Balance (DB: ${balanceFromDb}, Calc: ${calculatedBalance}, Final: ${balance})`);
          document.getElementById("feesTotal").textContent = total.toLocaleString() || "N/A";
          document.getElementById("feesPaid").textContent = totalPaid.toLocaleString() || "N/A";
          document.getElementById("feesBalance").textContent = balance.toLocaleString() || "N/A";
          document.getElementById("feesStatement").textContent = statement;

          const transactionsBody = document.getElementById("transactionsBody");
          transactionsBody.innerHTML = "";
          if (Array.isArray(transactions)) {
            transactions.forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "-"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "-"}</td>
                <td>${tx.payer || "-"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "-"}</td>
              </tr>`;
            });
          } else if (typeof transactions === "object") {
            Object.values(transactions).forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "-"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "-"}</td>
                <td>${tx.payer || "-"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "-"}</td>
              </tr>`;
            });
          }

        } else {
          showError("Student data not found.");
        }
      }).catch((error) => {
        showError("Failed to load data: " + error.message);
        console.log("Error loading student data:", error);
      });

      // Announcements
      const normalizedRegNo = regNo.replace(/\//g, "_");
      db.ref("announcements").once("value", (snapshot) => {
        const generalSnaps = ["ann1", "ann2", "ann3"].map(key => snapshot.child(key).val()).filter(s => s);
        const individualSnap = snapshot.child("individual").child(normalizedRegNo).val() || {};
        let announcements = [];

        Promise.all(generalSnaps.map(snap => {
          if (snap && snap.author) {
            return getUserNameByEmail(snap.author + ".stacc@moke.ac", snap.role === "accountant" ? "accountants" : "teachers").then(name => {
              announcements.push({ ...snap, key: snap.key || "ann1", type: "general", author: name });
            });
          }
        })).then(() => {
          Object.keys(individualSnap).forEach(key => {
            if (individualSnap[key].sender) {
              getUserNameByEmail(individualSnap[key].sender, "teachers").then(name => {
                announcements.push({ ...individualSnap[key], key, type: "individual", sender: name });
              });
            }
          });

          const announcementsList = document.getElementById("announcementsList");
          announcementsList.innerHTML = "";
          if (announcements.length === 0) {
            announcementsList.innerHTML = "<p>No announcements available.</p>";
            return;
          }

          announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
          announcements.forEach(ann => {
            const isRead = localStorage.getItem(`announcement_${ann.key}_${normalizedRegNo}`) === "read";
            const maker = ann.type === "general" ? ann.author : ann.sender;
            const div = document.createElement("div");
            div.className = `announcement ${isRead ? "read" : "unread"}`;
            div.innerHTML = `
              <h2>${ann.title || ann.text || ann.message}</h2>
              <p>${ann.message || ann.text}</p>
              <p><strong>By:</strong> <strong>${maker || "Unknown"}</strong> (${ann.date})</p>
              ${ann.type === "individual" ? "<p><strong>To:</strong> You</p>" : ""}
              <button class="mark-read" onclick="markAsRead('${ann.key}')">Mark as Read</button>
            `;
            announcementsList.appendChild(div);
          });
        });
      }).catch((error) => {
        showError("Failed to load announcements: " + error.message);
        console.log("Error loading announcements:", error);
      });
    };

    function markAsRead(key) {
      const regNo = sessionStorage.getItem("regNo").replace(/\//g, "_");
      localStorage.setItem(`announcement_${key}_${regNo}`, "read");
      window.onload();
    }

    function logout() {
      sessionStorage.clear();
      console.log("Logged out, redirecting to index.html");
      window.location.href = "index.html";
    }
  </script>