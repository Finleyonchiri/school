<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Portal - BORABU TTC</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #333;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: linear-gradient(to bottom, #6b48ff, #ff6f61);
      color: #fff;
      padding: 20px;
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .sidebar .profile {
      text-align: center;
      margin-bottom: 30px;
    }
    .sidebar .profile img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #ffd700;
      margin-bottom: 10px;
    }
    .sidebar h2 {
      font-size: 24px;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    .sidebar a, .sidebar button {
      display: block;
      color: #fff;
      padding: 15px;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
      transition: background 0.3s;
    }
    .sidebar a:hover, .sidebar button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    .section {
      display: none;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .section.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border: 1px solid #ddd;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background: #6b48ff;
      color: #fff;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
      }
    }
    select, input, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      padding: 12px 20px;
      background: linear-gradient(to right, #ff6f61, #ff9f61);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    button:hover {
      background: linear-gradient(to right, #ff9f61, #ff6f61);
    }
    .edit-btn {
      padding: 8px 15px;
      background: #6b48ff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .edit-btn:hover {
      background: #5a3de6;
    }
    .error-message {
      color: #ff4444;
      font-size: 16px;
      margin: 15px 0;
      padding: 10px;
      background: #ffebee;
      border-radius: 5px;
    }
    .success-message {
      color: #00cc00;
      font-size: 16px;
      margin: 15px 0;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 5px;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      display: none;
    }
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-screen.hidden {
      display: none;
    }
    .add-student-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      max-width: 600px;
    }
    .full-width {
      grid-column: span 2;
    }
    .announcement-item {
      margin-bottom: 15px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    .scores-table {
      margin-top: 20px;
    }
    .marks-form {
      display: grid;
      gap: 15px;
    }
    .subject-row {
      display: flex;
      align-items: center;
      gap: 20px; /* Increased spacing from subjects */
    }
    .subject-row input[type="number"],
    .subject-row input[type="text"] {
      width: 100px;
      margin-left: 10px; /* Aligns inputs vertically */
    }
    .search-bar {
      width: 100%;
      max-width: 300px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div>Loading...</div>
  </div>
  <div class="popup-overlay" id="popupOverlay" onclick="hidePopup()"></div>
  <div class="popup" id="popupMessage"></div>
  <div class="container">
    <div class="sidebar">
      <div class="profile">
        <img src="https://img.icons8.com/color/80/000000/teacher.png" alt="Teacher Icon">
        <p id="teacherName"></p>
      </div>
      <h2>Teacher Portal</h2>
      <a href="#" onclick="showSection('students')">Students</a>
      <a href="#" onclick="showSection('addStudent')">Add Student</a>
      <a href="#" onclick="showSection('marks')">Upload Marks</a>
      <a href="#" onclick="showSection('announcements')">Announcements</a>
      <button onclick="logout()">Logout</button>
    </div>
    <div class="main-content">
      <div id="students" class="section active">
        <h1 style="font-size: 28px;">Students</h1>
        <input type="text" id="searchStudent" class="search-bar" placeholder="Search by Reg No or Name..." onkeyup="searchStudents()">
        <select id="formSelect" onchange="loadStudents()">
          <option value="form1">Form 1</option>
          <option value="form2">Form 2</option>
          <option value="form3">Form 3</option>
          <option value="form4">Form 4</option>
        </select>
        <div id="studentsMessage" class="error-message"></div>
        <table id="studentsTable">
          <thead>
            <tr>
              <th>Reg No</th>
              <th>Name</th>
              <th>Stream</th>
              <th>Form</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentsBody"></tbody>
        </table>
        <div id="editStudentForm" style="display: none; margin-top: 20px;">
          <h3 style="font-size: 20px;">Edit Student</h3>
          <input id="editRegNo" type="text" disabled>
          <input id="editName" type="text" placeholder="Name" required>
          <input id="editPassword" type="password" placeholder="New Password">
          <select id="editForm" required>
            <option value="form1">Form 1</option>
            <option value="form2">Form 2</option>
            <option value="form3">Form 3</option>
            <option value="form4">Form 4</option>
          </select>
          <input id="editStream" type="text" placeholder="Stream" required>
          <button onclick="saveStudentEdits()">Save Changes</button>
          <div id="editStudentMessage" class="error-message"></div>
        </div>
      </div>
      <div id="addStudent" class="section">
        <h1 style="font-size: 28px;">Add Student</h1>
        <div class="add-student-form">
          <input id="newRegNo" type="text" placeholder="Reg No (e.g., AID/00119/025)" class="full-width" required>
          <input id="newName" type="text" placeholder="Name" required>
          <input id="newPassword" type="password" placeholder="Password" required>
          <select id="newForm" required>
            <option value="form1">Form 1</option>
            <option value="form2">Form 2</option>
            <option value="form3">Form 3</option>
            <option value="form4">Form 4</option>
          </select>
          <input id="newStream" type="text" placeholder="Stream (e.g., Victors)" required>
          <input id="newGender" type="text" placeholder="Gender (e.g., Male/Female)" required>
          <input id="newSponsor" type="text" placeholder="Sponsor (e.g., Self/Church)" required>
          <input id="newParentName" type="text" placeholder="Parent Name" required>
          <input id="newParentPhone" type="tel" placeholder="Parent Phone (e.g., 0712345678)" required>
          <input id="newTotalFees" type="number" placeholder="Total Expected Fees (KES)" required>
          <button onclick="addStudent()" class="full-width">Add Student</button>
        </div>
        <div id="addStudentMessage" class="error-message"></div>
      </div>
      <div id="marks" class="section">
        <h1 style="font-size: 28px;">Upload Marks</h1>
        <select id="marksFormSelect" onchange="loadMarksForm()">
          <option value="form1">Form 1</option>
          <option value="form2">Form 2</option>
          <option value="form3">Form 3</option>
          <option value="form4">Form 4</option>
        </select>
        <select id="marksStudentSelect" onchange="updateMarksForm()">
          <option value="">Select a student</option>
        </select>
        <select id="termSelect" onchange="updateMarksForm()">
          <option value="term1">Term 1</option>
          <option value="term2">Term 2</option>
          <option value="term3">Term 3</option>
        </select>
        <div id="marksForm"></div>
        <div id="scoresTable" class="scores-table"></div>
        <button id="uploadMarksBtn" onclick="uploadMarks()">Upload Marks</button>
        <button id="editMarksBtn" style="display: none;" onclick="enableEditMode()">Edit Marks</button>
        <div id="marksMessage" class="error-message"></div>
      </div>
      <div id="announcements" class="section">
        <h1 style="font-size: 28px;">Announcements</h1>
        <select id="announcementType" onchange="loadAnnouncementForm()">
          <option value="general">General</option>
          <option value="individual">Individual</option>
        </select>
        <select id="announcementStudent" style="display: none;"></select>
        <input id="announcementTitle" type="text" placeholder="Title" required>
        <textarea id="announcementMessage" placeholder="Message" required></textarea>
        <button onclick="addAnnouncement()">Add Announcement</button>
        <div id="announcementsMessage" class="error-message"></div>
        <div id="existingAnnouncements"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCi9NWfDwbWSByd_R7ueNkLcQsFlBJ5_VA",
      authDomain: "web-reg-cbf2f.firebaseapp.com",
      databaseURL: "https://web-reg-cbf2f-default-rtdb.firebaseio.com",
      projectId: "web-reg-cbf2f",
      storageBucket: "web-reg-cbf2f.firebasestorage.app",
      messagingSenderId: "431303341740",
      appId: "1:431303341740:web:542070e4c471cd7c8ad109",
      measurementId: "G-164GMVZQY3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loadingScreen = document.getElementById("loadingScreen");
    const popupOverlay = document.getElementById("popupOverlay");
    const popupMessage = document.getElementById("popupMessage");

    auth.onAuthStateChanged(async user => {
      if (!user || sessionStorage.getItem("userType") !== "teacher") {
        sessionStorage.clear();
        window.location.href = "index.html";
      } else {
        try {
          const teacherEmail = sessionStorage.getItem("username") || "Teacher";
          const teacherName = teacherEmail.split("@")[0].replace(/\d/g, "");
          document.getElementById("teacherName").textContent = teacherName;
          loadingScreen.classList.add("hidden");
          await loadStudents();
          await loadMarksForm();
          await loadAnnouncements();
        } catch (error) {
          console.error("Auth state error:", error);
          showPopup(`Failed to load: ${error.message}`, true);
        }
      }
    });

    const subjects = [
      "English", "Mathematics", "Kiswahili", "Biology", "Chemistry", "Physics",
      "History", "Geography", "CRE", "Business Studies", "Computer Studies"
    ];

    function showSection(section) {
      document.querySelectorAll(".section").forEach(div => div.classList.remove("active"));
      document.getElementById(section).classList.add("active");
    }

    function showPopup(message, isError = true) {
      popupMessage.textContent = message;
      popupMessage.className = isError ? "error-message" : "success-message";
      popupOverlay.style.display = "block";
      popupMessage.style.display = "block";
      setTimeout(hidePopup, isError ? 3000 : 5000);
    }

    function hidePopup() {
      popupOverlay.style.display = "none";
      popupMessage.style.display = "none";
    }

    function validateRegNo(regNo) {
      const invalidChars = /[.#$\[\]]/;
      return !invalidChars.test(regNo);
    }

    async function addStudent() {
      const regNo = document.getElementById("newRegNo").value.trim();
      const normalizedRegNo = regNo.replace(/\//g, "_");
      const name = document.getElementById("newName").value.trim();
      const password = document.getElementById("newPassword").value;
      const form = document.getElementById("newForm").value;
      const stream = document.getElementById("newStream").value.trim();
      const gender = document.getElementById("newGender").value.trim();
      const sponsor = document.getElementById("newSponsor").value.trim();
      const parentName = document.getElementById("newParentName").value.trim();
      const parentPhone = document.getElementById("newParentPhone").value.trim();
      const totalFees = parseInt(document.getElementById("newTotalFees").value);

      if (!regNo || !name || !password || !form || !stream || !gender || !sponsor || !parentName || !parentPhone || !totalFees) {
        showPopup("All fields are required.", true);
        return;
      }

      if (!validateRegNo(normalizedRegNo)) {
        showPopup("Invalid Reg No format. Avoid '.', '#', '$', '[', or ']'.", true);
        return;
      }

      try {
        const studentRef = db.ref("users/students/" + normalizedRegNo);
        const snapshot = await studentRef.once("value");
        if (snapshot.exists()) {
          showPopup("Reg No already exists.", true);
          return;
        }

        const newStudent = {
          profile: { name, password, gender, sponsor, parentName, parentPhone },
          form,
          stream,
          fees: { totalExpected: totalFees, transactions: [] },
          academics: {},
          marks: {}
        };
        await studentRef.set(newStudent);
        showPopup("Student added successfully!", false);
        document.getElementById("newRegNo").value = "";
        document.getElementById("newName").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("newStream").value = "";
        document.getElementById("newGender").value = "";
        document.getElementById("newSponsor").value = "";
        document.getElementById("newParentName").value = "";
        document.getElementById("newParentPhone").value = "";
        document.getElementById("newTotalFees").value = "";
        await loadStudents();
      } catch (error) {
        console.error("Add student error:", error);
        showPopup(`Failed to add student: ${error.message}`, true);
      }
    }

    async function loadStudents() {
      const form = document.getElementById("formSelect").value;
      const studentsBody = document.getElementById("studentsBody");
      studentsBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

      try {
        const snapshot = await db.ref("users/students").once("value");
        const students = snapshot.val() || {};
        let studentsList = [];

        Object.keys(students).forEach(regNo => {
          const student = students[regNo];
          if (student.form === form) {
            studentsList.push({
              regNo,
              name: student.profile.name,
              stream: student.stream,
              form: student.form
            });
          }
        });

        studentsBody.innerHTML = "";
        if (studentsList.length === 0) {
          studentsBody.innerHTML = `<tr><td colspan="5">No students found in ${form}.</td></tr>`;
          return;
        }

        studentsList.sort((a, b) => a.regNo.localeCompare(b.regNo));
        studentsList.forEach(student => {
          studentsBody.innerHTML += `<tr>
            <td>${student.regNo}</td>
            <td>${student.name}</td>
            <td>${student.stream}</td>
            <td>${student.form}</td>
            <td><button class="edit-btn" onclick="editStudent('${student.regNo}', '${student.name}', '${student.form}', '${student.stream}')">Edit</button></td>
          </tr>`;
        });
      } catch (error) {
        console.error("Load students error:", error);
        studentsBody.innerHTML = `<tr><td colspan="5">Failed to load students: ${error.message}</td></tr>`;
        showPopup(`Error: ${error.message}`, true);
      }
    }

    function searchStudents() {
      const searchTerm = document.getElementById("searchStudent").value.toLowerCase();
      const form = document.getElementById("formSelect").value;
      const studentsBody = document.getElementById("studentsBody");
      studentsBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

      db.ref("users/students").once("value", (snapshot) => {
        const students = snapshot.val() || {};
        let studentsList = [];

        Object.keys(students).forEach(regNo => {
          const student = students[regNo];
          if (student.form === form && (student.profile.name.toLowerCase().includes(searchTerm) || regNo.toLowerCase().includes(searchTerm))) {
            studentsList.push({
              regNo,
              name: student.profile.name,
              stream: student.stream,
              form: student.form
            });
          }
        });

        studentsBody.innerHTML = "";
        if (studentsList.length === 0) {
          studentsBody.innerHTML = `<tr><td colspan="5">No students found matching '${searchTerm}' in ${form}.</td></tr>`;
          return;
        }

        studentsList.sort((a, b) => a.regNo.localeCompare(b.regNo));
        studentsList.forEach(student => {
          studentsBody.innerHTML += `<tr>
            <td>${student.regNo}</td>
            <td>${student.name}</td>
            <td>${student.stream}</td>
            <td>${student.form}</td>
            <td><button class="edit-btn" onclick="editStudent('${student.regNo}', '${student.name}', '${student.form}', '${student.stream}')">Edit</button></td>
          </tr>`;
        });
      }).catch(error => {
        studentsBody.innerHTML = `<tr><td colspan="5">Failed to search students: ${error.message}</td></tr>`;
        showPopup(`Error: ${error.message}`, true);
      });
    }

    function editStudent(regNo, name, form, stream) {
      const editForm = document.getElementById("editStudentForm");
      editForm.style.display = "block";
      document.getElementById("editRegNo").value = regNo;
      document.getElementById("editName").value = name;
      document.getElementById("editPassword").value = "";
      document.getElementById("editForm").value = form;
      document.getElementById("editStream").value = stream;
    }

    async function saveStudentEdits() {
      const regNo = document.getElementById("editRegNo").value;
      const normalizedRegNo = regNo.replace(/\//g, "_");
      const name = document.getElementById("editName").value.trim();
      const password = document.getElementById("editPassword").value;
      const form = document.getElementById("editForm").value;
      const stream = document.getElementById("editStream").value.trim();

      if (!name || !form || !stream) {
        showPopup("Name, Form, and Stream are required.", true);
        return;
      }

      try {
        const updates = { profile: { name }, form, stream };
        if (password) updates.profile.password = password;

        await db.ref(`users/students/${normalizedRegNo}`).update(updates);
        showPopup("Student updated successfully!", false);
        document.getElementById("editStudentForm").style.display = "none";
        await loadStudents();
      } catch (error) {
        console.error("Save student edits error:", error);
        showPopup(`Failed to update student: ${error.message}`, true);
      }
    }

    function loadMarksForm() {
      const formSelect = document.getElementById("marksFormSelect");
      const studentSelect = document.getElementById("marksStudentSelect");
      studentSelect.innerHTML = "<option>Loading...</option>";
      const form = formSelect.value;

      db.ref("users/students").once("value", (snapshot) => {
        const students = snapshot.val() || {};
        let studentsList = [];

        Object.keys(students).forEach(regNo => {
          const student = students[regNo];
          if (student.form === form) {
            studentsList.push({
              regNo,
              name: student.profile.name,
              stream: student.stream
            });
          }
        });

        studentSelect.innerHTML = "";
        if (studentsList.length === 0) {
          studentSelect.innerHTML = `<option value="">No students found in ${form}.</option>`;
          document.getElementById("marksForm").innerHTML = "";
          document.getElementById("scoresTable").innerHTML = "";
          return;
        }

        studentsList.sort((a, b) => a.regNo.localeCompare(b.regNo));
        studentSelect.innerHTML = `<option value="">Select a student</option>`;
        studentsList.forEach(student => {
          studentSelect.innerHTML += `<option value="${student.regNo}|${student.stream}">${student.name} (${student.regNo})</option>`;
        });

        updateMarksForm();
      }).catch(error => {
        document.getElementById("marksForm").innerHTML = `<div class="error-message">Failed to load marks form: ${error.message}</div>`;
      });
    }

    function updateMarksForm() {
      const term = document.getElementById("termSelect").value;
      const studentSelect = document.getElementById("marksStudentSelect");
      const marksForm = document.getElementById("marksForm");
      const scoresTable = document.getElementById("scoresTable");

      marksForm.innerHTML = "";
      scoresTable.innerHTML = "";

      if (!studentSelect.value) {
        marksForm.innerHTML = "<p>Please select a student to upload marks for.</p>";
        return;
      }

      const [regNo] = studentSelect.value.split("|");
      const normalizedRegNo = regNo.replace(/\//g, "_");

      marksForm.innerHTML = `<div class="marks-form"><h3 style="font-size: 20px; margin-bottom: 15px;">Mark Sheet</h3>`;
      subjects.forEach((subject, index) => {
        marksForm.innerHTML += `
          <div class="subject-row">
            <strong>${index + 1}. ${subject}</strong>
            ${term !== "term3" ? `<input type="number" id="cat_${subject}" placeholder="CAT" min="0" max="100">` : ""}
            <input type="number" id="exam_${subject}" placeholder="Exam" min="0" max="100">
            <input type="text" id="grade_${subject}" placeholder="Grade" pattern="[A-F][+-]?" title="Enter grade like A, A+, B-, etc.">
          </div>`;
      });
      marksForm.innerHTML += `</div>`;

      db.ref(`users/students/${normalizedRegNo}/academics/${term}`).once("value", snapshot => {
        const marksData = snapshot.val() || {};
        let scoresHTML = "<h3 style='font-size: 20px; margin-bottom: 15px;'>Current Scores</h3>";
        scoresHTML += "<table><thead><tr><th>Subject</th><th>CAT</th><th>Exam</th><th>Grade</th></tr></thead><tbody>";
        subjects.forEach(subject => {
          const cat = marksData.cat?.[subject] || "-";
          const exam = marksData.exam?.[subject] || "-";
          const grade = marksData.grades?.[subject] || "-";
          scoresHTML += `<tr>
            <td>${subject}</td>
            <td>${cat}</td>
            <td>${exam}</td>
            <td>${grade}</td>
          </tr>`;
        });
        scoresHTML += "</tbody></table>";
        scoresTable.innerHTML = scoresHTML;
      }).catch(error => {
        scoresTable.innerHTML = `<div class="error-message">Error loading scores: ${error.message}</div>`;
      });
    }

    function enableEditMode() {
      document.getElementById("uploadMarksBtn").style.display = "inline-block";
      document.getElementById("editMarksBtn").style.display = "none";
      updateMarksForm();
    }

    function uploadMarks() {
      const studentSelect = document.getElementById("marksStudentSelect");
      if (!studentSelect.value) {
        showPopup("Please select a student to upload marks for.", true);
        return;
      }

      const [regNo] = studentSelect.value.split("|");
      const normalizedRegNo = regNo.replace(/\//g, "_");
      const term = document.getElementById("termSelect").value;

      db.ref(`users/students/${normalizedRegNo}/academics/${term}`).once("value", async (snapshot) => {
        const existingMarks = snapshot.val() || {};
        const marks = { cat: { ...existingMarks.cat }, exam: { ...existingMarks.exam }, grades: { ...existingMarks.grades } };
        let hasData = false;

        subjects.forEach(subject => {
          if (existingMarks.cat?.[subject] || existingMarks.exam?.[subject] || existingMarks.grades?.[subject]) {
            hasData = true;
          }
          const catMarks = document.getElementById(`cat_${subject}`).value;
          const examMarks = document.getElementById(`exam_${subject}`).value;
          const gradeInput = document.getElementById(`grade_${subject}`).value.trim().toUpperCase();

          if (catMarks && term !== "term3") marks.cat[subject] = parseInt(catMarks);
          if (examMarks) marks.exam[subject] = parseInt(examMarks);
          if (gradeInput) {
            const gradeMatch = gradeInput.match(/^([A-F])([+-])?$/);
            if (gradeMatch) {
              marks.grades[subject] = gradeMatch[1] + (gradeMatch[2] || "");
            } else {
              showPopup(`Invalid grade format for ${subject}. Use A-F with optional + or -.`, true);
              return;
            }
          }
        });

        if (Object.keys(marks.cat).length === 0) delete marks.cat;
        if (Object.keys(marks.exam).length === 0) delete marks.exam;
        if (Object.keys(marks.grades).length === 0) delete marks.grades;

        if (Object.keys(marks).every(key => !marks[key] || Object.keys(marks[key]).length === 0)) {
          showPopup("Please enter at least one mark or grade.", true);
          return;
        }

        if (hasData && document.getElementById("editMarksBtn").style.display !== "none") {
          showPopup("Marks already exist for this term. Please press 'Edit Marks' to modify.", true);
          return;
        }

        loadingScreen.classList.remove("hidden");
        document.getElementById("uploadMarksBtn").disabled = true;
        await new Promise(resolve => setTimeout(resolve, 3000));

        await db.ref(`users/students/${normalizedRegNo}/academics/${term}`).update(marks)
          .then(() => {
            loadingScreen.classList.add("hidden");
            document.getElementById("uploadMarksBtn").disabled = false;
            document.getElementById("editMarksBtn").style.display = "inline-block";
            document.getElementById("uploadMarksBtn").style.display = "none";
            showPopup("Marks uploaded successfully!", false); // Added success pop-up
            updateMarksForm();
          })
          .catch(error => {
            loadingScreen.classList.add("hidden");
            document.getElementById("uploadMarksBtn").disabled = false;
            showPopup(`Failed to upload marks: ${error.message}`, true);
          });
      }).catch(error => {
        showPopup(`Error loading existing marks: ${error.message}`, true);
      });
    }

    async function loadAnnouncements() {
      const existingAnnouncements = document.getElementById("existingAnnouncements");
      existingAnnouncements.innerHTML = "<p>Loading announcements...</p>";

      try {
        const generalSnapshot = await db.ref("announcements/general").once("value");
        const individualSnapshot = await db.ref("announcements/individual").once("value");
        let announcements = [];

        generalSnapshot.forEach(childSnapshot => {
          const data = childSnapshot.val();
          announcements.push({ ...data, type: "general", key: childSnapshot.key });
        });

        individualSnapshot.forEach(childSnapshot => {
          childSnapshot.forEach(indivSnap => {
            const data = indivSnap.val();
            announcements.push({ ...data, type: "individual", key: indivSnap.key, regNo: childSnapshot.key });
          });
        });

        if (announcements.length === 0) {
          existingAnnouncements.innerHTML = "<p>No announcements found.</p>";
          return;
        }

        announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
        existingAnnouncements.innerHTML = "";
        announcements.forEach(ann => {
          existingAnnouncements.innerHTML += `<div class="announcement-item">
            <h4>${ann.title} (${ann.date})</h4>
            <p>${ann.message}</p>
            <p><strong>Posted by:</strong> ${ann.teacher}</p>
            ${ann.type === "individual" ? `<p><strong>To:</strong> ${ann.regNo}</strong></p>` : ""}
          </div>`;
        });
      } catch (error) {
        console.error("Load announcements error:", error);
        existingAnnouncements.innerHTML = `<div class="error-message">Failed to load announcements: ${error.message}</div>`;
      }
    }

    function loadAnnouncementForm() {
      const typeSelect = document.getElementById("announcementType");
      const studentSelect = document.getElementById("announcementStudent");
      studentSelect.style.display = typeSelect.value === "individual" ? "block" : "none";
      if (typeSelect.value !== "individual") return;

      studentSelect.innerHTML = "<option>Loading...</option>";
      db.ref("users/students").once("value", (snapshot) => {
        const students = snapshot.val() || {};
        let studentsList = [];

        Object.keys(students).forEach(regNo => {
          const student = students[regNo];
          studentsList.push({ regNo, name: student.profile.name });
        });

        studentSelect.innerHTML = "";
        if (studentsList.length === 0) {
          studentSelect.innerHTML = `<option value="">No students found.</option>`;
          return;
        }

        studentsList.sort((a, b) => a.regNo.localeCompare(b.regNo));
        studentsList.forEach(student => {
          studentSelect.innerHTML += `<option value="${student.regNo}">${student.name} (${student.regNo})</option>`;
        });
      }).catch(error => {
        studentSelect.innerHTML = `<option>Failed to load students: ${error.message}</option>`;
      });
    }

    function addAnnouncement() {
      const type = document.getElementById("announcementType").value;
      const title = document.getElementById("announcementTitle").value.trim();
      const message = document.getElementById("announcementMessage").value.trim();

      if (!title || !message) {
        showPopup("Please enter both title and message.", true);
        return;
      }

      const announcement = {
        title,
        message,
        date: new Date().toISOString().split("T")[0],
        teacher: document.getElementById("teacherName").textContent
      };

      const ref = type === "general" ? db.ref("announcements/general").push() : db.ref(`announcements/individual/${document.getElementById("announcementStudent").value}`).push();
      ref.set(announcement)
        .then(() => {
          showPopup("Announcement added successfully!", false);
          document.getElementById("announcementTitle").value = "";
          document.getElementById("announcementMessage").value = "";
          loadAnnouncements();
        })
        .catch(error => {
          showPopup(`Failed to add announcement: ${error.message}`, true);
        });
    }

    function logout() {
      auth.signOut().then(() => {
        sessionStorage.clear();
        window.location.href = "index.html";
      }).catch(error => {
        console.error("Logout failed:", error);
        showPopup(`Failed to log out: ${error.message}`, true);
      });
    }
  </script>
</body>
</html>